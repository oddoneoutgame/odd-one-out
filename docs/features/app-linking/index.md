# Digital Asset Links / Android App Links

## Background

In Android 6.0, [Android App Linking](https://developer.android.com/about/versions/marshmallow/android-6.0#app-linking) was introduced. This allows us to do two things:

1. Associate an application with a web domain that is owned by the developer. This allows us to indicate to the android system that `https://www.disneyplus.com` and `https://www.starplus.com` are owned by us, thus ensuring any links clicked are handled by our applications by default.
2. Share credentials from Chrome's password storing in to our application via Smart Lock.

In order for this to work, we must do the following:

* Add the intent filter with `autoVerify` in the manifest. This is currently done in our mobile `AndroidManifest` (see [here](https://github.bamtech.co/Android/Dmgz/blob/b27c7a7827357e9cf486ca3413747dfd90d70cd9/core/src/main/AndroidManifest.xml#L46)).
    * There are some caveats, however:
        1. This only works on hosts that are capable of hosting the `assetlinks.json` file _without_ a 302 redirect.
        2. This only works if there are no custom urls scheme included in the `<intent-filter>`. It may only include `http` and `https`
            * Note: Number one applies here still. So, if `http://www.disneyplus.com` (non-secure) redirects to `https://www.disneyplus.com` (secure), the app linking will break.
* Declare association between our application and our website.

## Declaring Association

First, it is best to get up to speed by reading [Google's Documentation](https://developers.google.com/digital-asset-links/v1/getting-started) (as well as additional documentation below in the [Additional Resources](#additional-resources)). Secondly, it's important to understand that these files have already been created for [Disney+](https://www.disneyplus.com/.well-known/assetlinks.json) and [Star+](https://www.starplus.com/.well-known/assetlinks.json). This portion of the documentation will show how to get some of the data needed for the files as well as how to update the files via our git repositories.

### Updating `assetlinks.json`

In order to update the `assetlinks.json` file, you will need to follow the instructions below:

* Pull down the following repository: [site-dominguez/android-wellknown](https://github.bamtech.co/site-dominguez/android-wellknown).
    * If you do not have access, please ask for access in the `#web-core-services` channel on Slack.
* Create a new branch.
* Find the necessary file.
    * If updating Disney+, use the `files/disneyPlus/assetlinks.json` file.
    * If updating Star+, use the `/files/starPlus/assetlinks.json` file.
* Make the changes
* Push the branch
* Open a PR.
* Here is an [example PR](https://github.bamtech.co/site-dominguez/android-wellknown/pull/7/files).

### Finding the Fingerprint of an APK

The `assetlinks.json` file uses the SHA-256 fingerprint of the keystore for security reasons. You will need to find the keystore of the application that you are wanting to add to the fingerprints. For example, in [this PR](https://github.bamtech.co/site-dominguez/android-wellknown/pull/6), we added the fingerprint of the debug keystore. This can be done in the following way:

* Obtain the keystore of the application you are looking to find the SHA-256 fingerprint for.
    * You will need the keystore and the keystore password.
* Open a terminal to where the keystore is found.
* Run the following command:

```sh
keytool -list -v -keystore /Path/To/keystore.jks
```

* You will then be prompted to enter the keystore password. Enter the password.
* You will see an output similar to the one below
    * This was generated by getting the default debug keystore in the Android SDK: `keytool -list -v -keystore ~/.android/debug.keystore`

```sh hl_lines="12"
Alias name: androiddebugkey
Creation date: Jul 28, 2020
Entry type: PrivateKeyEntry
Certificate chain length: 1
Certificate[1]:
Owner: C=US, O=Android, CN=Android Debug
Issuer: C=US, O=Android, CN=Android Debug
Serial number: 1
Valid from: Tue Jul 28 13:21:55 EDT 2020 until: Thu Jul 21 13:21:55 EDT 2050
Certificate fingerprints:
	 SHA1: 7C:F8:75:EE:09:A4:15:E4:0C:A3:DF:5E:89:CE:4E:07:CE:F5:5E:18
	 SHA256: 00:F9:9D:90:65:78:42:D8:EE:6D:D1:F8:A2:1D:F8:21:B5:13:B3:E9:6B:15:62:E4:CC:E0:C7:DC:09:D1:20:BB
Signature algorithm name: SHA1withRSA (weak)
Subject Public Key Algorithm: 2048-bit RSA key
Version: 1
```

* The `SHA256` is the relevant data.

## Verifying App Links

You can verify that the App Links have been established successfully.

First way to do so is via automatic verification. To do this, simply install the APK's and look for the `IntentFilterIntentOp` tag. You will see similar messages to the following:

```sh
# Disney+
I/IntentFilterIntentOp: Verifying IntentFilter. verificationId:61 scheme:"https" hosts:"www.disneyplus.com" package:"com.disney.disneyplus". [CONTEXT service_id=244 ]
I/IntentFilterIntentOp: Verification 61 complete. Success:true. Failed hosts:. [CONTEXT service_id=244 ]

# Star+
I/IntentFilterIntentOp: Verifying IntentFilter. verificationId:62 scheme:"https" hosts:"www.starplus.com" package:"com.disney.starplus". [CONTEXT service_id=244 ]
I/IntentFilterIntentOp: Verification 62 complete. Success:true. Failed hosts:. [CONTEXT service_id=244 ]
```

On Android 12 and above, one can do [manual verification](https://developer.android.com/training/app-links/verify-site-associations#manual-verification) using ADB.

* First, until we target API 31, we will need to run the following command to enable the new verification process that is included in Android 12. Once we update to API 31, it is enabled by default. TODO - DMGZAND-8999 - We can remove this.
    * `adb shell am compat enable 175408749 com.disney.disneyplus`
    * `adb shell am compat enable 175408749 com.disney.starplus`
* Next, reset the state of Android App Links on the your device, so that the device behaves as if the user has never chosen a default app:
    * `adb shell pm set-app-links --package com.disney.disneyplus 0 all`
    * `adb shell pm set-app-links --package com.disney.starplus 0 all`
* Perform the verification:
    * `adb shell pm verify-app-links --re-verify com.disney.disneyplus`
    * `adb shell pm verify-app-links --re-verify com.disney.starplus`
* **Note**: It is important to wait a few minutes here. The above command performs network requests on the domains that are attempting to be verified. Without waiting to perform the next step, the results may be wrong.
* Review the results:
    * `adb shell pm get-app-links com.disney.disneyplus`
    * `adb shell pm get-app-links com.disney.starplus`
* You will see results similar to below:

```sh
# Disney+
com.disney.disneyplus:
  ID: 2c23415e-09dc-4912-9312-a82ece8bc258
  Signatures: [71:DC:D3:86:D7:50:C2:4A:0E:64:C1:B7:F7:43:B5:BC:79:90:03:D0:68:EC:B1:75:F3:0C:97:C3:84:E3:CC:2F]
  Domain verification state:
    www.disneyplus.com: verified

# Star+
com.disney.starplus:
  ID: 454b344c-cdc9-45b9-9d83-40b17e708062
  Signatures: [71:DC:D3:86:D7:50:C2:4A:0E:64:C1:B7:F7:43:B5:BC:79:90:03:D0:68:EC:B1:75:F3:0C:97:C3:84:E3:CC:2F]
  Domain verification state:
    www.starplus.com: verified
```

## Additional Resources

* Our current links:
    * [Disney+](https://www.disneyplus.com/.well-known/assetlinks.json)
    * [Star+](https://www.starplus.com/.well-known/assetlinks.json)
* [Disney Streaming android-wellknown repo](https://github.bamtech.co/site-dominguez/android-wellknown)
    * [Example PR](https://github.bamtech.co/site-dominguez/android-wellknown/pull/6)
* [Digital Asset Link Documentation](https://developers.google.com/digital-asset-links/v1/getting-started)
* [App Link Developer Overview](https://developer.android.com/training/app-links)
* [Verifying App Links on Android 12](https://developer.android.com/training/app-links/verify-site-associations#manual-verification)
